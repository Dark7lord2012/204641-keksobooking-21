(()=>{"use strict";window.network={upload:(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send(),o.addEventListener("load",(()=>{200===o.status?e(o.response):t(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${o.timeout}мс`)})),o.timeout=1e4},save:(e,t,o)=>{const r=new XMLHttpRequest;r.responseType="json",r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(e),r.addEventListener("load",(()=>200===r.status?t():o())),r.timeout=1e4}},(()=>{const e="any",t=document.querySelector("#housing-price"),o=document.querySelector("#housing-type"),r=document.querySelector("#housing-rooms"),n=document.querySelector("#housing-guests"),a=document.querySelector("#filter-wifi"),s=document.querySelector("#filter-dishwasher"),d=document.querySelector("#filter-parking"),l=document.querySelector("#filter-washer"),i=document.querySelector("#filter-elevator"),c=document.querySelector("#filter-conditioner"),u=t=>(o.value!==e&&(t=t.filter((e=>e.offer.type===o.value))),t),m=o=>(t.value!==e&&("low"===t.value?o=o.filter((e=>e.offer.price<1e4)):"middle"===t.value?o=o.filter((e=>e.offer.price>=1e4&&e.offer.price<5e4)):"high"===t.value&&(o=o.filter((e=>e.offer.price>=5e4)))),o),p=t=>(r.value!==e&&(t=t.filter((e=>e.offer.rooms===parseInt(r.value,10)))),t),f=t=>(n.value!==e&&(t=t.filter((e=>e.offer.guests===parseInt(n.value,10)))),t),y=e=>(a.checked&&(e=e.filter((e=>e.offer.features.includes("wifi")))),e),v=e=>(s.checked&&(e=e.filter((e=>e.offer.features.includes("dishwasher")))),e);window.filter={housingType:o,filterType:u,filterPrice:m,filterRooms:p,filterGuests:f,filterWifi:y,filterDishwasher:v,filterAllOptions:e=>(e=u(e),e=m(e),e=p(e),e=f(e),e=y(e),(e=>(c.checked&&(e=e.filter((e=>e.offer.features.includes("conditioner")))),e))(e=(e=>(i.checked&&(e=e.filter((e=>e.offer.features.includes("elevator")))),e))(e=(e=>(l.checked&&(e=e.filter((e=>e.offer.features.includes("washer")))),e))(e=(e=>(d.checked&&(e=e.filter((e=>e.offer.features.includes("parking")))),e))(e=v(e))))))}})(),(()=>{const e=["img/avatars/user01.png","img/avatars/user02.png","img/avatars/user03.png","img/avatars/user04.png","img/avatars/user05.png","img/avatars/user06.png","img/avatars/user07.png","img/avatars/user08.png"],t=["palace","flat","house","bungalow"],o=["12:00","13:00","14:00"],r=["12:00","13:00","14:00"],n=["wifi","dishwasher","parking","washer","elevator","conditioner"],a=["http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],s=document.querySelector(".map__pins"),d=document.querySelector(".map__overlay").offsetWidth-20,l=e=>e[Math.round(Math.random()*(e.length-1))],i=(e,t)=>Math.round(Math.random()*(t-e)+e),c=(e,t=i(0,e.length-1))=>{const o=e;for(let t=o.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return o.slice(0,t)};window.data={AVATARS:e,TYPE_APARTMENT:t,TYPE_APARTMENT_RUSSIAN:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},CHECHKIN:o,CHECHKOUT:r,FEATURES:n,PHOTOS:a,MAP_RANGE_TOP:130,MAP_RANGE_BOTTOM:630,mapPins:s,mapWidth:d,randomElementArray:l,getRandomNumber:i,getRandomArray:c,removeChildrenNode:(e,t=null)=>{for(;e.firstChild;)e.removeChild(e.firstChild);null!==t&&e.appendChild(t)},generateApartments:s=>{const u=[];for(let m=0;m<s;m++)u[m]={author:{avatar:""+e[i(0,e.length-1)]},offer:{title:"Cтрока, заголовок предложения",address:"Площадь Сталина",price:1300,type:l(t),rooms:i(1,3),guests:i(1,2),checkin:l(o),checkout:l(r),features:c(n),description:null,photos:c(a)},location:{x:i(0,d),y:i(130,630)}};return u}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelectorAll(".map__filter"),o=e.querySelector(".map__features"),r=e.querySelector(".map__pins"),n=r.querySelector(".map__pin--main"),a=r.querySelectorAll(".map__pin"),s=document.querySelector(".ad-form"),d=s.querySelector(".ad-form-header"),l=s.querySelectorAll(".ad-form__element"),i=s.querySelector(".ad-form-header__preview img").src,c=s.querySelector(".ad-form__photo-container").innerHTML,u={x:n.style.left,y:n.style.top},m=()=>{e.classList.add("map--faded"),s.classList.add("ad-form--disabled");for(let e of t)e.disabled=!0;o.disabled=!0;for(let e of a)e.classList.contains("map__pin--main")||(e.disabled=!0);n.style.left=u.x,n.style.top=u.y,d.disabled=!0;for(let e of l)e.disabled=!0;s.querySelector(".ad-form-header__preview img").src=i,s.querySelector(".ad-form__photo-container").innerHTML=c};m(),window.map={mapFilters:t,mapFeatures:o,pins:a,mapPins:r,adFormHeader:d,adFormElements:l,deactivateForms:m}})(),(()=>{const e=window.data.TYPE_APARTMENT_RUSSIAN,t=document.querySelector("#card").content.querySelector(".popup"),o=window.data.removeChildrenNode,r=document.querySelector(".map__filters-container"),n=document.querySelector(".map"),a=r=>{const n=t.cloneNode(!0),a=n.querySelector(".popup__title");r.offer.title?a.textContent=r.offer.title:a.remove();const s=n.querySelector(".popup__text--address");r.offer.address?s.textContent=r.offer.address:s.remove();const d=n.querySelector(".popup__text--price");r.offer.price?d.textContent=r.offer.price+"₽/ночь":d.remove();const l=n.querySelector(".popup__type");r.offer.type?l.textContent=e[r.offer.type]:l.remove();const i=n.querySelector(".popup__text--capacity");r.offer.rooms&&r.offer.guests?i.textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`:i.remove();const c=n.querySelector(".popup__text--time");r.offer.checkin&&r.offer.checkout?c.textContent=`Заезд после ${r.offer.checkin} выезд до ${r.offer.checkout}`:c.remove();const u=n.querySelector(".popup__features"),m=n.querySelector(".popup__feature");if(r.offer.features&&r.offer.features.length>0){o(u);for(let e=0;e<r.offer.features.length;e++){const t=m.cloneNode(!0);t.className="popup__feature popup__feature--"+r.offer.features[e],u.appendChild(t)}}else u.remove();const p=n.querySelector(".popup__description");r.offer.description?p.textContent=r.offer.description:p.remove();const f=n.querySelector(".popup__photos"),y=n.querySelector(".popup__photo");if(r.offer.photos&&r.offer.photos.length>0){o(f);for(let e=0;e<r.offer.photos.length;e++){const t=y.cloneNode(!0);t.src=""+r.offer.photos[e],f.appendChild(t)}}else f.remove();const v=n.querySelector(".popup__avatar");return r.author.avatar?v.src=r.author.avatar:v.remove(),n},s=()=>{l()},d=e=>{"Escape"===e.key&&l()},l=()=>{document.removeEventListener("keydown",d),document.querySelector(".popup__close").removeEventListener("click",s);const e=document.querySelector(".popup");e&&n.removeChild(e)};window.card={renderCard:a,showCardPopup:e=>{const t=a(e);document.querySelector(".popup")&&l(),n.insertBefore(t,r),t.querySelector(".popup__close").addEventListener("click",s),document.addEventListener("keydown",d)},closeCardPopup:l,onBtnCloseCardClick:s,onCardPopupKeydown:d}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}},(()=>{const e=window.data.MAP_RANGE_TOP,t=window.data.MAP_RANGE_BOTTOM,o=document.querySelector("#pin").content.querySelector("button"),r=document.querySelector(".map__pin--main"),n=document.querySelector("#address"),a=window.data.removeChildrenNode,s=window.map.mapFilters,d=window.map.mapFeatures,l=window.map.adFormHeader,i=window.map.adFormElements,c=window.data.mapPins,u=window.card.showCardPopup,m=window.data.mapWidth,p=(e,t)=>{const o=parseInt(e.style.left,10),r=parseInt(e.style.top,10),n=e.offsetWidth,a=e.offsetHeight;t.value=`${Math.round(o+n/2)}, ${Math.round(r+a/2)}`};p(r,n);const f=e=>{let t=o.cloneNode(!0),r=t.querySelector("img");return r.src=e.author.avatar,r.alt=e.offer.title,t.style.left=e.location.x-t.offsetWidth/2+"px",t.style.top=e.location.y-t.offsetHeight+"px",t},y=()=>{r.style.transform="translateY(-100%)",document.querySelector(".map").classList.remove("map--faded"),d.disabled=!1;for(let e of s)e.disabled=!1;document.querySelector(".ad-form").classList.remove("ad-form--disabled"),l.disabled=!1;for(let e of i)e.disabled=!1;const e=document.createDocumentFragment();window.network.upload((t=>{let o=t,n=window.filter.filterAllOptions(o);n=n.slice(0,5),t=n;for(let o=0;o<t.length;o++){const r=t[o];if(r.offer){const t=f(r);e.appendChild(t),t.addEventListener("click",(()=>{u(r)}))}}a(c,r),c.appendChild(e)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: rgba(240, 0, 0, 0.3);",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.color="white",t.style.fontSize="20px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}))},v=o=>{if(0===o.button){let a={x:o.clientX,y:o.clientY};const s=o=>{let n=a.x-o.clientX,s=a.y-o.clientY;a={x:o.clientX,y:o.clientY};let d=r.offsetTop-s,l=r.offsetLeft-n;d<e&&(d=e),d>t&&(d=t),l<0&&(l=0),l>m&&(l=m),r.style.top=d+"px",r.style.left=l+"px"},d=()=>{y(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d),p(r,n)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",d)}},h=e=>{"Enter"===e.key&&(y(),r.removeEventListener("mousedown",v),r.removeEventListener("keydown",h))};r.addEventListener("mousedown",v),r.addEventListener("keydown",h),window.pin={templatePin:o,mainPin:r,renderPin:f,activateForms:y,onFormsActivateMousedown:v,onFormsActivateKeydown:h,removePins:(e,t)=>{window.data.removeChildrenNode(e,t)}}})(),(()=>{const e=window.pin.activateForms,t=window.card.closeCardPopup,o=document.querySelector("#housing-type"),r=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),a=document.querySelector("#housing-guests"),s=document.querySelector("#filter-wifi"),d=document.querySelector("#filter-dishwasher"),l=document.querySelector("#filter-parking"),i=document.querySelector("#filter-washer"),c=document.querySelector("#filter-elevator"),u=document.querySelector("#filter-conditioner"),m=()=>{window.debounce(e)(),document.querySelector(".map__card")&&t()};o.addEventListener("change",m),r.addEventListener("change",m),n.addEventListener("change",m),a.addEventListener("change",m),s.addEventListener("change",m),d.addEventListener("change",m),l.addEventListener("change",m),i.addEventListener("change",m),c.addEventListener("change",m),u.addEventListener("change",m)})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#type"),o=e.querySelector("#price"),r=e.querySelector("#timein"),n=e.querySelector("#timeout"),a=e.querySelector("#room_number"),s=e.querySelector("#capacity").querySelectorAll("option"),d=e.querySelector(".ad-form__reset"),l=document.querySelector(".map__pins"),i=l.querySelector(".map__pin--main"),c=document.querySelector(".map__filters"),u="0",m="1000",p="5000",f="10000",y=()=>{switch(t.value){case"bungalow":o.min=u,o.placeholder=u;break;case"flat":o.min=m,o.placeholder=m;break;case"house":o.min=p,o.placeholder=p;break;case"palace":o.min=f,o.placeholder=f}},v=()=>{y()};t.addEventListener("change",v);const h=()=>{"12:00"===r.value?n.value="12:00":"13:00"===r.value?n.value="13:00":"14:00"===r.value&&(n.value="14:00")},w=()=>{"12:00"===n.value?r.value="12:00":"13:00"===n.value?r.value="13:00":"14:00"===n.value&&(r.value="14:00")},g=()=>{h()},S=()=>{w()};r.addEventListener("change",g),n.addEventListener("change",S);const _=()=>{for(let e of s)e.disabled=!1;let e;if("1"===a.value){for(let t of s)"1"!==t.value?(t.disabled=!0,t.selected=!1):e=t;e.selected=!0}else if("2"===a.value){for(let t of s)"1"!==t.value&&"2"!==t.value?t.disabled=!0:e=t;e.selected=!0}else if("3"===a.value){for(let t of s)"1"!==t.value&&"2"!==t.value&&"3"!==t.value?t.disabled=!0:e=t;e.selected=!0}else if("100"===a.value){for(let t of s)"0"!==t.value?t.disabled=!0:e=t;e.selected=!0}},q=()=>{_()};a.addEventListener("change",q);const E=()=>{y(),h(),w(),_()};E(),e.addEventListener("submit",(t=>{window.network.save(new FormData(e),L,k),t.preventDefault()}));const L=()=>{const t=document.querySelector("#success").content,o=document.querySelector("main"),r=t.cloneNode(!0);o.appendChild(r);const n=document.querySelector(".success"),a=()=>{n.remove(),e.reset(),window.map.deactivateForms(),window.pin.removePins(l,i),E(),n.removeEventListener("click",a)},s=e=>{"Escape"===e.key&&(n.remove(),document.removeEventListener("keydown",s))};n.addEventListener("click",a),document.addEventListener("keydown",s)},k=()=>{const e=document.querySelector("#error").content,t=document.querySelector("main"),o=e.cloneNode(!0);t.appendChild(o);const r=document.querySelector(".error"),n=r.querySelector(".error__button"),a=()=>{r.remove(),r.removeEventListener("click",a)},s=e=>{"Escape"===e&&(r.remove(),r.removeEventListener("keydown",s))};r.addEventListener("click",a),r.addEventListener("keydown",s),n.addEventListener("click",a)};d.addEventListener("click",(()=>{window.map.deactivateForms(),window.data.removeChildrenNode(l,i),e.reset(),c.reset(),e.querySelector("#images").addEventListener("change",window.photo.onImagesChooserClick)})),window.form={setTypeApartment:y,onTypeApartmentChange:v,setTimeInApartment:h,setTimeOutApartment:w,onTimeInApartmentChange:g,onTimeOutApartmentChange:S,setRoomsApartment:_,onRoomsApartmentChange:q}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#avatar"),o=document.querySelector(".ad-form-header__preview img"),r=document.querySelector("#images"),n=document.querySelector(".ad-form__photo"),a=document.querySelector(".ad-form__photo-container"),s=document.querySelector(".ad-form__upload");t.addEventListener("change",(()=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(r)}}));const d=()=>{const t=r.files;window.data.removeChildrenNode(a,s);for(let o of t){const t=o.name.toLowerCase();if(e.some((e=>t.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const t=document.createElement("img"),o=n.cloneNode(!0);t.src=e.result,t.style.maxWidth="100%",t.style.height="auto",t.style.maxHeight="100%",t.style.display="block",t.style.margin="auto",o.style.display="flex",o.appendChild(t),a.appendChild(o)})),e.readAsDataURL(o)}}};r.addEventListener("change",d),window.photo={onImagesChooserClick:d}})()})();